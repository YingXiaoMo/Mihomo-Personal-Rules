name: Compile Rules to MRS

on:
  push:
    paths:
      - 'rules/*.list'
    branches:
      - main
  workflow_dispatch:

jobs:
  compile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Mihomo (Auto Latest)
        run: |
  
          VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Detected latest version: ${VERSION}"
          
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/mihomo-linux-amd64-${VERSION}.gz"
          echo "Downloading from: $URL"
          
          wget -O mihomo.gz "$URL"
          gzip -d mihomo.gz
          chmod +x mihomo

      - name: Compile Rules
        run: |
          for file in rules/*.list; do
            dir=$(dirname "$file")
            filename=$(basename "$file")
            name="${filename%.*}"
            output="${dir}/${name}.mrs"
            
            if [[ "$filename" == "gta.list" || "$filename" == "proxydns.list" ]]; then
              echo "Skipping $filename (No compilation needed)"
              continue
            fi
            
            type="domain"
            [[ "$filename" == *"ip"* ]] && type="ipcidr"
            
            echo "Compiling $file to $output (Type: $type)..."
            
            temp_file="${dir}/${name}.temp.list"
            
            grep -v '^#' "$file" | grep -v '^\s*$' | tr -d '\r' > "$temp_file"
            
            ./mihomo convert-ruleset "$type" text "$temp_file" "$output"
            rm "$temp_file"
          done

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto compile rules to .mrs binary"
          file_pattern: '**/*.mrs'